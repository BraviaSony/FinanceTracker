import{readFileSync as M,promises as j}from"fs";import{fileURLToPath as W}from"url";import{dirname as G,join as N}from"path";import{TraceMap as I,originalPositionFor as D}from"@jridgewell/trace-mapping";var H=["warn","error","debug"],U="rebolt:broadcast:console",V="rebolt:broadcast:error",R=/\r?\n/g,_=2;function O(m,l){if(typeof l=="number")return l;let r=m.split(R),{line:t,column:a}=l,o=0;for(let u=0;u<t-1&&u<r.length;u++)o+=r[u].length+1;return o+a}function F(m,l=0,r){l=Math.max(O(m,l),0),r=Math.min(r!==void 0?O(m,r):l,m.length);let t=m.split(R),a=0,o=[];for(let u=0;u<t.length;u++){if(a+=t[u].length,a>=l){for(let h=u-_;h<=u+_||r>a;h++){if(h<0||h>=t.length)continue;let v=h+1;o.push(`${v}${" ".repeat(Math.max(3-String(v).length,0))}|  ${t[h]}`);let k=t[h].length;if(h===u){let y=Math.max(l-(a-k),0),C=Math.max(1,(r||0)>a?k-y:(r||0)-l);o.push(`   |  ${" ".repeat(y)}${"^".repeat(C)}`)}else if(h>u){if((r||0)>a){let y=Math.max(Math.min((r||0)-a,k),1);o.push(`   |  ${"^".repeat(y)}`)}a+=k+1}}break}a++}return o.join(`
`)}function J(m){return m.split(/\n/g).filter(l=>/^\s*at/.test(l)).join(`
`)}function K(m){let l=m.split(`
`),r=[],t=[],a=o=>o.includes("node_modules/")||o.includes(".vite/deps/")||o.includes("/@vite/")||o.includes("/@id/");for(let o of l)a(o)?t.push(o):(t.length>0&&(t.length===1?r.push(t[0]):(r.push(t[0]),r.push(`    ... ${t.length-1} library frames omitted`)),t=[]),r.push(o));return t.length>0&&(t.length===1?r.push(t[0]):(r.push(t[0]),r.push(`    ... ${t.length-1} library frames omitted`))),r.join(`
`)}function L(m,l,r){let t,a=[],o=J(m).split(`
`);for(let v of o){let k=v.replace(/^ {4}at (?:(\S+?) )?\(?(?:https?|http):\/\/[^/]+([/][^:]+):(\d+):(\d+)\)?$/,(y,C,i,f,S)=>{if(!i)return y;let $=l.urlToModuleMap.get(i);if(!$)return"";let c=Number(f),n=Number(S),p=$?.transformResult?.map;if(r&&p)try{let E=new I(p),e=D(E,{line:c,column:n-1});e.source&&e.line!=null&&e.line>=0&&e.column!=null&&e.column>=0&&(c=e.line,n=e.column+1)}catch{}let w=C?.trim(),g=$.file,s=`${$.file}:${c}:${n}`;return g&&(t||(t={line:c,column:n,file:g})),!w||w==="eval"?`    at ${s}`:`    at ${w} ${s}`});a.push(k)}let u=a.join(`
`);return{stack:K(u),loc:t}}var q=W(import.meta.url),x=G(q);function T(m={}){let{enabled:l=!0,broadcast:r="sender",sendOverlay:t=!0,overlayOnConsoleError:a=!1,rewriteSourceMaps:o=!0,dedupeWindowMs:u=500,filterError:h,filterConsole:v}=m,k="rebolt-broadcaster",y=new Map;function C(i){let f=Date.now(),S=y.get(i)||0;if(f-S<u)return!0;y.set(i,f);for(let[$,c]of y.entries())f-c>u*4&&y.delete($);return!1}return{name:k,apply:(i,f)=>l&&f.command==="serve"&&!i.ssr,enforce:"pre",transformIndexHtml(i){if(!l)return{html:i,tags:[]};let f=N(x,"bootstrap.js"),S=M(f,"utf-8"),$=N(x,"posthog.js"),c=M($,"utf-8");return{html:i,tags:[{tag:"script",injectTo:"head-prepend",children:c},{tag:"script",injectTo:"head-prepend",attrs:{type:"module"},children:S}]}},configureServer(i){let f=i.config.logger,S=(c,n)=>{let p={timestamp:!0};switch(c){case"error":f.error(n,p);break;case"warn":f.warn(n,p);break;default:f.info(n,p);break}},$=async(c,n)=>{if(c.message.startsWith("[vite]"))return;let p=c.stack||"",{stack:w,loc:g}=L(p,i.moduleGraph,o),s={name:"Error",message:c.message,stack:w,loc:g,plugin:k};if(g?.file)try{s.id=g.file;let b=await j.readFile(g.file,"utf-8");s.frame=F(b,{line:g.line,column:g.column-1})}catch(b){f.error(`[rebolt] Failed to generate code frame: ${String(b)}`,{timestamp:!0})}if(h&&!h(s))return;let E=`${s.message}|${s.loc?.file}|${s.loc?.line}|${s.loc?.column}`;if(C(E))return;let e=s.loc?`${s.loc.file}:${s.loc.line}:${s.loc.column}`:"unknown",d=`[rebolt:error] ${s.message} @ ${e}`;if(s.frame&&(d+=`
Code frame:
`+s.frame.split(`
`).map(b=>`    ${b}`).join(`
`)),S("error",d),t){let b={type:"error",err:s};r==="all"?i.ws.send(b):n?.send(b)}};i.ws.on(V,(c,n)=>{Promise.resolve($(c,n)).catch(p=>f.error(`[rebolt] error handling runtime error: ${String(p)}`,{timestamp:!0}))}),i.ws.on(U,c=>{Promise.resolve((async()=>{let n=c;if(!H.includes(n.level)||v&&!v(n))return;let p=(n.args||[]).map(e=>typeof e=="string"?e:e&&typeof e=="object"?(()=>{try{return JSON.stringify(e)}catch{return String(e)}})():String(e)).join(" ");if(p.startsWith("[vite]")||p.includes("[vite]"))return;let w=[];for(let e of n.args||[])e&&typeof e=="object"&&e.__isError&&typeof e.stack=="string"&&w.push(e.stack);let g=[];for(let e of w){let{stack:d}=L(e,i.moduleGraph,o);g.push(d)}let s=n.url?` (${n.url})`:"",E=`[rebolt:${n.level}] ${p}${s}`;if(g.length>0&&(E+=`
`+g.map(e=>e.split(`
`).map(d=>`    ${d}`).join(`
`)).join(`
`)),S(n.level,E),a&&n.level==="error"&&t){let e=g[0]??"",d;try{if(w[0]){let P=L(w[0],i.moduleGraph,o);e=P.stack||e,d=P.loc}}catch{}let b={name:"ConsoleError",message:p,stack:e,loc:d,plugin:k};if(d?.file)try{let P=await j.readFile(d.file,"utf-8");b.id=d.file,b.frame=F(P,{line:d.line,column:d.column-1})}catch{}let A={type:"error",err:b};i.ws.send(A)}})()).catch(n=>f.error(`[rebolt] error handling console payload: ${String(n)}`,{timestamp:!0}))})}}}export{T as default};
